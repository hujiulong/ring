var Ring=new function(){function e(e,t,o,i,r){F=document.getElementById(r),null===F&&(F=document.createElement("div"),F.id=r,document.body.appendChild(F)),N=F.offsetWidth,P=F.offsetHeight,g(),z(),n(e,t,o,i),l(c)}function t(e,t){switch(e){case"models":return k.model+t+".js";case"font":return k.font+t+".json";case"shape":return k.shape+t.substring(1,t.length-1)+".js"}return null}function n(e,n,o,i){I=a(n),W.materialName=n,W.fontName=i,W.text=e,W.model=o,W.modelUrl=t("models",o),y(e)?(W.type="shape",W.shapeUrl=t("shape",e),W.fontUrl=t("font",i)):(W.type="text",W.fontUrl=t("font",i)),"9-1"==o?"text"==W.type&&(W.rotationCalibrated.set(0,0,0),W.positionCalibrated.set(0,0,0),W.cutFlag=!0):"9-2"==o?("text"==W.type?(W.rotationCalibrated.set(0,0,0),W.positionCalibrated.set(0,0,0),W.cutFlag=!0):"shape"==W.type&&(W.rotationCalibrated.set(0,0,0),W.positionCalibrated.set(0,0,-20)),W.cutFlag=!0):"9-3"==o?"text"==W.type&&(W.textHeight=150,W.rotationCalibrated.set(0,0,6/180*Math.PI),W.positionCalibrated.set(0,37,0),W.cutFlag=!0):"9-4"==o?"text"==W.type&&(W.rotationCalibrated.set(0,0,0),W.positionCalibrated.set(-5,0,-20),W.cutFlag=!0):"9-5"==o?"text"==W.type&&(W.rotationCalibrated.set(0,0,0),W.positionCalibrated.set(0,0,0),W.cutFlag=!0,W.depth=50):(W.rotationCalibrated.set(0,0,0),W.positionCalibrated.set(0,0,0),W.cutFlag=!0)}function o(e,o){if("text"==e)O.remove(D),O.remove(j),S.remove(O),O=new THREE.Object3D,W.text=o,y(W.text)?(W.type="shape",W.shapeUrl=t("shape",W.text),null==J.shapeGeometry&&s(W.shapeUrl,c)):(W.type="text",c());else if("height"==e)O.scale.y=o/W.height;else if("material"==e)for(var i=a(o),r=0;r<O.children.length;r++)O.children[r].material=i;else if("model"==e){n(W.text,W.materialName,o,W.fontName),S.remove(O),O=new THREE.Object3D,W.modelUrl="models/"+o+".js";var l=new THREE.JSONLoader;l.load(W.modelUrl,function(e,t){J.ringGeometry=e.clone(),c(e)})}}function i(e){switch(e){case"text":return W.text;case"height":return W.height}}function r(e,t){var n=new THREE.MeshPhongMaterial(e);return n.name=t,n}function a(e){for(var t=0;t<_.length;t++)if(_[t].name==e)return _[t];return _[0]}function l(e){function t(){o.load(W.fontUrl,function(t){n=t,J.font=n,i.load(W.modelUrl,function(t,n){J.ringGeometry=t.clone(),e()})})}var n,o=new THREE.FontLoader,i=new THREE.JSONLoader;"shape"==W.type?i.load(W.shapeUrl,function(e,n){J.shapeGeometry=e,t()}):"text"==W.type&&t()}function s(e,t){var e,n=new THREE.JSONLoader;"shape"==W.type?e=W.shapeUrl:"text"==W.type&&(e=W.modelUrl),n.load(e,function(e,n){"shape"==W.type?J.shapeGeometry=e:"text"==W.type&&(J.ringGeometry=e),t()})}function c(){console.log("load "+((new Date).getTime()-L)+"ms"),"shape"==W.type?j=E():"text"==W.type&&(j=d()),D=u(),h()}function g(){U=new THREE.PerspectiveCamera(45,N/P,1,1e4),U.position.set(0,700,2800),A=new THREE.OrbitControls(U,F),A.enableDamping=!0,A.dampingFactor=.15,A.minDistance=100,A.maxDistance=3500,A.rotateSpeed=.15,S=new THREE.Scene,e=new THREE.DirectionalLight(16777190,.95),e.position.set(0,100,200),S.add(e),e=new THREE.DirectionalLight(16777190,.75),e.position.set(0,-100,-200),S.add(e);var e=new THREE.HemisphereLight(13365758,16773846,.4);S.add(e);var e=new THREE.AmbientLight(4210752);S.add(e),G=new THREE.WebGLRenderer({antialias:!0}),G.setPixelRatio(window.devicePixelRatio),G.setClearColor(15658734),G.setSize(N,P),F.appendChild(G.domElement),C=new Stats,C.domElement.style.position="absolute",C.domElement.style.top="0px",C.domElement.style.zIndex=100,F.appendChild(C.domElement),window.addEventListener("resize",V,!1)}function h(){O.add(D);j&&(j=b(D.origin,D.radius,j),j.position.copy(W.positionCalibrated),j.position.y-=W.textHeight/2,j.rotation.copy(W.rotationCalibrated),O.add(j)),S.add(O);var e=new THREE.Box3;e.setFromObject(O),console.log(e),console.log("total "+((new Date).getTime()-L)+"ms")}function u(){function e(e,t,n){return!!(W.cutFlag&&e.distanceToPoint(n)>0&&t.distanceToPoint(n)>0)}if("9-3"==W.model)return m();var t,n=J.ringGeometry.clone(),o=new THREE.Vector3,i=[],r=[],a=[],l=[];n.computeBoundingBox();var s=1e3/(n.boundingBox.max.x-n.boundingBox.min.x),c=0;n.boundingBox.max.z-n.boundingBox.min.z<n.boundingBox.max.y-n.boundingBox.min.y&&(c=-Math.PI/2);var g=(new THREE.Matrix4).makeRotationX(c).multiply((new THREE.Matrix4).makeScale(s,s,s));n.applyMatrix(g),n.verticesNeedUpdate=!0,n.computeBoundingBox(),t=(n.boundingBox.max.x-n.boundingBox.min.x)/2,o.set(t+n.boundingBox.min.x,0,t+n.boundingBox.min.z),W.height=n.boundingBox.max.y-n.boundingBox.min.y;var h=null==j?0:(j.width/2-7)/(t+j.depth/2),u=(new THREE.Vector3).crossVectors(new THREE.Vector3(0,0,1).applyAxisAngle(new THREE.Vector3(0,1,0),h).normalize(),new THREE.Vector3(0,1,1).applyAxisAngle(new THREE.Vector3(0,1,0),h).normalize()).normalize(),d=(new THREE.Vector3).crossVectors(new THREE.Vector3(0,0,1).applyAxisAngle(new THREE.Vector3(0,1,0),-h).normalize(),new THREE.Vector3(0,1,1).applyAxisAngle(new THREE.Vector3(0,1,0),-h).normalize()).normalize(),E=new THREE.Plane;E.setFromNormalAndCoplanarPoint(u.normalize(),o);var x=new THREE.Plane;x.setFromNormalAndCoplanarPoint(d.normalize().negate(),o);for(var y=0;y<n.faces.length;y++){var v=n.faces[y],R=n.vertices[v.a],T=n.vertices[v.b],H=n.vertices[v.c],f=[R,T,H],b=[0,0,0],B=[],V=[];e(E,x,R)&&(b[0]=1),e(E,x,T)&&(b[1]=1),e(E,x,H)&&(b[2]=1);for(var z=0;z<b.length;z++)b[z]?V.push(f[z]):B.push(f[z]);if(0==V.length)i.push(R,T,H),r.push(new THREE.Face3(i.length-1,i.length-2,i.length-3));else if(1==V.length){var M,L,F=new THREE.Line3(V[0],B[0]),C=new THREE.Line3(V[0],B[1]),N=1,P=1;void 0!=(M=E.intersectLine(F))?N=1:(M=x.intersectLine(F),N=2),void 0!=(L=E.intersectLine(C))?P=1:(L=x.intersectLine(C),P=2),i.push(B[0],B[1],M,L);var U=w(i[i.length-1].clone(),o,t-20).sub(M.clone());r.push(p(i,i.length-1,i.length-2,i.length-3,U)),r.push(p(i,i.length-2,i.length-3,i.length-4,U)),1==N?a.push(i.length-2):l.push(i.length-2),1==P?a.push(i.length-1):l.push(i.length-1)}else if(2==V.length){var M,L,F=new THREE.Line3(B[0],V[0]),C=new THREE.Line3(B[0],V[1]),N=1,P=1;void 0!=(M=E.intersectLine(F))?N=1:(M=x.intersectLine(F),N=2),void 0!=(L=E.intersectLine(C))?P=1:(L=x.intersectLine(C),P=2),i.push(B[0],M,L);var U=w(i[i.length-1].clone(),o,t-20).sub(M.clone());r.push(p(i,i.length-1,i.length-2,i.length-3,U)),1==N?a.push(i.length-2):l.push(i.length-2),1==P?a.push(i.length-1):l.push(i.length-1)}}var A=new THREE.Geometry;A.vertices=i,A.faces=r;var S=[],G=[],D=new THREE.Geometry;W.cutFlag&&a.length>0&&l.length>0&&S.push(i[a[0]],i[l[0]]);for(var U=new THREE.Vector3(0,0,-1),y=2;y<a.length;y++)S.push(i[a[y-1]],i[a[y]]),G.push(p(S,0,S.length-1,S.length-2,U));for(var y=2;y<l.length;y++)S.push(i[l[y-1]],i[l[y]]),G.push(p(S,1,S.length-1,S.length-2,U));D.vertices=S,D.faces=G,D.mergeVertices(),D.computeFaceNormals(),D.computeVertexNormals(),A.mergeVertices(),A.computeFaceNormals(),A.computeVertexNormals(),A.merge(D);var O=new THREE.Mesh(A,I);return O.radius=t,O.origin=o,O}function m(){function e(e,t,n){return n.y>0&&e.distanceToPoint(n)>0&&n.z>0||n.y<0&&t.distanceToPoint(n)>0&&n.z>0}var t,n=J.ringGeometry.clone(),o=new THREE.Vector3,i=[],r=[],a=[],l=[];n.computeBoundingBox();var s=1e3/(n.boundingBox.max.x-n.boundingBox.min.x),c=0,g=Math.PI/14;n.boundingBox.max.z-n.boundingBox.min.z<n.boundingBox.max.y-n.boundingBox.min.y&&(c=-Math.PI/2);var h=(new THREE.Matrix4).makeRotationX(c).multiply((new THREE.Matrix4).makeRotationZ(g)).multiply((new THREE.Matrix4).makeScale(s,s,s));n.applyMatrix(h),n.verticesNeedUpdate=!0,n.normalsNeedUpdate=!0,n.computeBoundingBox(),t=(n.boundingBox.max.x-n.boundingBox.min.x)/2,o.set(t+n.boundingBox.min.x,0,t+n.boundingBox.min.z),W.height=n.boundingBox.max.y-n.boundingBox.min.y;var u=null==j?0:(j.width/2-7)/(t+j.depth/2),m=(new THREE.Vector3).crossVectors(new THREE.Vector3(0,0,1).applyAxisAngle(new THREE.Vector3(0,1,0),u).normalize(),new THREE.Vector3(0,1,1).applyAxisAngle(new THREE.Vector3(0,1,0),u).normalize()).applyAxisAngle(new THREE.Vector3(0,0,1),Math.PI/4).normalize().negate(),d=(new THREE.Vector3).crossVectors(new THREE.Vector3(0,0,1).applyAxisAngle(new THREE.Vector3(0,1,0),-u).normalize(),new THREE.Vector3(0,1,1).applyAxisAngle(new THREE.Vector3(0,1,0),-u).normalize()).applyAxisAngle(new THREE.Vector3(0,0,1),-Math.PI/4).normalize().negate(),E=new THREE.Plane;E.setFromNormalAndCoplanarPoint(m.normalize(),o);var x=new THREE.Plane;x.setFromNormalAndCoplanarPoint(d.normalize().negate(),o);for(var y=0;y<n.faces.length;y++){var v=n.faces[y],R=n.vertices[v.a],T=n.vertices[v.b],H=n.vertices[v.c],f=[R,T,H],b=[0,0,0],B=[],V=[];e(E,x,R)&&(b[0]=1),e(E,x,T)&&(b[1]=1),e(E,x,H)&&(b[2]=1);for(var z=0;z<b.length;z++)b[z]?V.push(f[z]):B.push(f[z]);if(0==V.length)i.push(R,T,H),r.push(new THREE.Face3(i.length-1,i.length-2,i.length-3));else if(1==V.length){var M,L,F=new THREE.Line3(V[0],B[0]),C=new THREE.Line3(V[0],B[1]),N=1,P=1;if(void 0!=(M=E.intersectLine(F))?N=1:(M=x.intersectLine(F),N=2),void 0!=(L=E.intersectLine(C))?P=1:(L=x.intersectLine(C),P=2),void 0===M||void 0==L)continue;i.push(B[0],B[1],M,L);var U=w(i[i.length-1].clone(),o,t-200).sub(M.clone());r.push(p(i,i.length-1,i.length-2,i.length-3,U)),r.push(p(i,i.length-2,i.length-3,i.length-4,U)),1==N?a.push(i.length-2):l.push(i.length-2),1==P?a.push(i.length-1):l.push(i.length-1)}else if(2==V.length){var M,L,F=new THREE.Line3(B[0],V[0]),C=new THREE.Line3(B[0],V[1]),N=1,P=1;if(void 0!=(M=E.intersectLine(F))?N=1:(M=x.intersectLine(F),N=2),void 0!=(L=E.intersectLine(C))?P=1:(L=x.intersectLine(C),P=2),void 0===M||void 0==L)continue;i.push(B[0],M,L);var U=w(i[i.length-1].clone(),o,t-200).sub(M.clone());r.push(p(i,i.length-1,i.length-2,i.length-3,U)),1==N?a.push(i.length-2):l.push(i.length-2),1==P?a.push(i.length-1):l.push(i.length-1)}}var A=new THREE.Geometry;A.vertices=i,A.faces=r;var S=[],G=[],D=new THREE.Geometry;W.cutFlag&&a.length>0&&l.length>0&&S.push(i[a[0]],i[l[0]]);for(var U=new THREE.Vector3(0,0,-1),y=2;y<a.length;y++)S.push(i[a[y-1]],i[a[y]]),G.push(p(S,0,S.length-1,S.length-2,U));for(var y=2;y<l.length;y++)S.push(i[l[y-1]],i[l[y]]),G.push(p(S,1,S.length-1,S.length-2,U));D.vertices=S,D.faces=G,D.mergeVertices(),D.computeFaceNormals(),D.computeVertexNormals(),A.mergeVertices(),A.computeFaceNormals(),A.computeVertexNormals(),A.merge(D);var h=(new THREE.Matrix4).makeRotationY(Math.PI/14);A.applyMatrix(h),A.verticesNeedUpdate=!0,A.normalsNeedUpdate=!0,A.computeBoundingBox();var O=new THREE.Mesh(A,I);return O.radius=t,O.origin=o,O}function d(){var e,t=W.text;if(""==t)return null;for(var n=0,o=0,i=0;i<t.length;i++)v(t[i])||i==t.length-1?(o&&(o=0,e=T(e,t.substring(n,i))),e=T(e,t[i])):o||(o=1,n=i);return e.geometry.computeBoundingBox(),e.width=e.geometry.boundingBox.max.x-e.geometry.boundingBox.min.x,e.height=e.geometry.boundingBox.max.y-e.geometry.boundingBox.min.y,e.depth=e.geometry.boundingBox.max.z-e.geometry.boundingBox.min.z,e}function E(){var e=J.shapeGeometry.clone(),t=new THREE.Mesh(e,I);return t.geometry.applyMatrix((new THREE.Matrix4).makeScale(50,50,50)),t.geometry.computeBoundingBox(),t.width=t.geometry.boundingBox.max.x-t.geometry.boundingBox.min.x,t.height=t.geometry.boundingBox.max.y-t.geometry.boundingBox.min.y,t.depth=t.geometry.boundingBox.max.z-t.geometry.boundingBox.min.z,t.geometry.applyMatrix((new THREE.Matrix4).setPosition(new THREE.Vector3(t.width/2,t.height/2,t.depth/2))),t}function p(e,t,n,o,i){var r=x(e[t].clone(),e[n].clone(),e[o].clone());return i.angleTo(r)<=Math.PI/2?new THREE.Face3(t,n,o):new THREE.Face3(o,n,t)}function x(e,t,n){var o=new THREE.Vector3,i=new THREE.Vector3;return o.subVectors(n,t),i.subVectors(e,t),o.cross(i),o.normalize()}function w(e,t,n){var o=e.clone().sub(t.clone().setY(e.y));return o.setLength(n)}function y(e){var t=/\[\S+\]/g;return t.test(e)}function v(e){return e>="A"&&e<="Z"||"p"==e||"s"==e||"1"==e}function R(e){return new THREE.TextGeometry(e,{size:W.textHeight,height:W.depth,curveSegments:5,font:J.font,weight:"bold",style:"normal",bevelEnabled:!0,bevelThickness:2,bevelSize:1})}function T(e,t,n){if(void 0===e)return new THREE.Mesh(R(t,n),I);e.geometry.computeBoundingBox();var o=e.geometry.clone(),i=R(t,n);o.computeBoundingBox(),i.computeBoundingBox();var r=o.boundingBox.max.x-o.boundingBox.min.x,a=i.boundingBox.max.x-o.boundingBox.min.x,l=i.boundingBox.max.y-o.boundingBox.min.y,s=!1,c=new THREE.Vector3(r,0,0);do{for(var g=c.clone().add(new THREE.Vector3(a/2,l/2,0)),h=0;h<i.vertices.length;h++)if(!(i.vertices[h].z!=g.z||i.vertices[h].x>=a/2)){var u=i.vertices[h].clone(),m=u.sub(new THREE.Vector3(a/2,l/2,0)),d=new THREE.Raycaster(g,m.clone().normalize()),E=d.intersectObject(e);if(E.length>0&&E[0].distance<m.length()){s=!0,o.merge(i,(new THREE.Matrix4).setPosition(c));break}}c.x-=3}while(!s);return new THREE.Mesh(o,I)}function H(e,t,n,o,i){var r=e[n.a],a=e[n.b],l=e[n.c],s=new THREE.Vector3((r.x+a.x)/2,(r.y+a.y)/2,(r.z+a.z)/2),c=new THREE.Vector3((r.x+l.x)/2,(r.y+l.y)/2,(r.z+l.z)/2),g=new THREE.Vector3((a.x+l.x)/2,(a.y+l.y)/2,(a.z+l.z)/2);e.push(s,c,g);var h=new THREE.Face3(e.length-3,n.a,e.length-2),u=new THREE.Face3(e.length-3,e.length-2,e.length-1),m=new THREE.Face3(n.b,e.length-3,e.length-1),d=new THREE.Face3(e.length-1,e.length-2,n.c);o==i?t.push(h,u,m,d):(H(e,t,h,o,i+1),H(e,t,u,o,i+1),H(e,t,m,o,i+1),H(e,t,d,o,i+1))}function f(e){for(var t=[],n=[],o=0;o<e.faces.length;o++){var i=e.faces[o],r=e.vertices[i.a],a=e.vertices[i.b],l=e.vertices[i.c],s=new THREE.Vector3(0,0,-1);t.push(r,a,l),"text"==W.type?s.angleTo(i.normal)>Math.PI/3?n.push(new THREE.Face3(t.length-3,t.length-2,t.length-1)):H(t,n,new THREE.Face3(t.length-3,t.length-2,t.length-1),1,0):"shape"==W.type&&H(t,n,new THREE.Face3(t.length-3,t.length-2,t.length-1),3,0)}var c=new THREE.Geometry;return c.faces=n,c.vertices=t,c.mergeVertices(),c}function b(e,t,n){var o=(new THREE.Matrix4).setPosition(new THREE.Vector3(-n.width/2,0,0));n.geometry.applyMatrix(o),n.geometry.verticesNeedUpdate=!0,n.geometry.computeFaceNormals(),n.geometry=f(n.geometry.clone()).clone();for(var i=t+n.depth/2,r=2*i*Math.PI,a=0;a<n.geometry.vertices.length;a++){var l=n.geometry.vertices[a].clone(),s=t-l.z,c=l.x,g=c/r*Math.PI*2;n.geometry.vertices[a].set(s*Math.sin(g),l.y,s*Math.cos(g)).add(e)}return n.geometry.verticesNeedUpdate=!0,n.geometry.mergeVertices(),n.geometry.computeFaceNormals(),n.geometry.computeVertexNormals(),n}function B(e){var t;e=e.toLowerCase(),window.URL=window.URL||window.webkitURL,window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder;var n=O.clone();if("obj"==e){var o=new THREE.OBJExporter;t=o.parse(n)}else if("stl"==e){var o=new THREE.STLExporter;t=o.parse(n)}var i=document.createElement("a");i.style.display="none",document.body.appendChild(i),i.href=URL.createObjectURL(new Blob([t],{type:"text/plain"})),i.download="model."+e,i.click()}function V(){U.aspect=window.innerWidth/window.innerHeight,U.updateProjectionMatrix(),G.setSize(window.innerWidth,window.innerHeight)}function z(){requestAnimationFrame(z),M()}function M(){C.update(),A.update(),G.render(S,U)}var L=(new Date).getTime();Detector.webgl||Detector.addGetWebGLMessage();var F,C,N,P,U,A,S,G,j,D,I,O=new THREE.Object3D,k={font:"fonts/",model:"models/",shape:"models/"},W={text:"hello",depth:70,height:0,type:"text",textHeight:158,shapeUrl:"",modelUrl:"",fontUrl:"",model:"",materialName:"gold_yellow",fontName:"",positionCalibrated:new THREE.Vector3(0,0,0),rotationCalibrated:new THREE.Euler(0,0,0),cutFlag:!0},J={font:null,shapeGeometry:null,ringGeometry:null},_=[],X=["img/px.jpg","img/nx.jpg","img/py.jpg","img/ny.jpg","img/pz.jpg","img/nz.jpg"],Y=THREE.ImageUtils.loadTextureCube(X);return Y.format=THREE.RGBFormat,_.push(r({color:16764482,specular:3355443,combine:THREE.MixOperation,envMap:Y,shininess:54,reflectivity:.75,side:THREE.DoubleSide,shading:THREE.SmoothShading},"gold_yellow")),_.push(r({color:16750995,specular:3355443,combine:THREE.MixOperation,envMap:Y,shininess:54,reflectivity:.75,side:THREE.DoubleSide,shading:THREE.SmoothShading},"gold_red")),_.push(r({color:16777215,specular:16777215,combine:THREE.MixOperation,envMap:Y,shininess:54,reflectivity:.75,side:THREE.DoubleSide,shading:THREE.SmoothShading},"silver")),{init:function(t,n,o,i,r){e(t,n,o,i,r)},change:function(e,t){o(e,t)},get:function(e){return i(e)},export:function(e){B(e)}}};