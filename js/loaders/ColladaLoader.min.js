THREE.ColladaLoader=function(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager},THREE.ColladaLoader.prototype={constructor:THREE.ColladaLoader,load:function(e,t,a,r){function n(e){var t=e.split("/");return t.pop(),(t.length<1?".":t.join("/"))+"/"}var i=this,o=new THREE.XHRLoader(i.manager);o.load(e,function(a){t(i.parse(a,n(e)))},a,r)},options:{set convertUpAxis(e){console.log("ColladaLoder.options.convertUpAxis: TODO")}},setCrossOrigin:function(e){this.crossOrigin=e},parse:function(e,t){function a(e,t){for(var a=[],r=e.childNodes,n=0,i=r.length;i>n;n++){var o=r[n];o.nodeName===t&&a.push(o)}return a}function r(e){if(0===e.length)return[];for(var t=e.trim().split(/\s+/),a=new Array(t.length),r=0,n=t.length;n>r;r++)a[r]=parseFloat(t[r]);return a}function n(e){if(0===e.length)return[];for(var t=e.trim().split(/\s+/),a=new Array(t.length),r=0,n=t.length;n>r;r++)a[r]=parseInt(t[r]);return a}function i(e){return e.substring(1)}function o(e){return{unit:s(a(e,"unit")[0]),upAxis:c(a(e,"up_axis")[0])}}function s(e){return void 0!==e?parseFloat(e.getAttribute("meter")):1}function c(e){return void 0!==e?e.textContent:"Y_UP"}function l(e,t,r,n,i){var o=a(e,r)[0];if(void 0!==o)for(var s=a(o,n),c=0;c<s.length;c++)i(s[c])}function d(e,t){for(var a in e){var r=e[a];r.build=t(e[a])}}function u(e,t){return void 0!==e.build?e.build:(e.build=t(e),e.build)}function f(e){var t={init_from:a(e,"init_from")[0].textContent};fe.images[e.getAttribute("id")]=t}function m(e){if(void 0!==e.build)return e.build;var a=e.init_from;return void 0!==t&&(a=t+a),re.load(a)}function h(e){return u(fe.images[e],m)}function p(e){for(var t={},a=0,r=e.childNodes.length;r>a;a++){var n=e.childNodes[a];if(1===n.nodeType)switch(n.nodeName){case"profile_COMMON":t.profile=v(n)}}fe.effects[e.getAttribute("id")]=t}function v(e){for(var t={surfaces:{},samplers:{}},a=0,r=e.childNodes.length;r>a;a++){var n=e.childNodes[a];if(1===n.nodeType)switch(n.nodeName){case"newparam":g(n,t);break;case"technique":t.technique=E(n)}}return t}function g(e,t){for(var a=e.getAttribute("sid"),r=0,n=e.childNodes.length;n>r;r++){var i=e.childNodes[r];if(1===i.nodeType)switch(i.nodeName){case"surface":t.surfaces[a]=b(i);break;case"sampler2D":t.samplers[a]=N(i)}}}function b(e){for(var t={},a=0,r=e.childNodes.length;r>a;a++){var n=e.childNodes[a];if(1===n.nodeType)switch(n.nodeName){case"init_from":t.init_from=n.textContent}}return t}function N(e){for(var t={},a=0,r=e.childNodes.length;r>a;a++){var n=e.childNodes[a];if(1===n.nodeType)switch(n.nodeName){case"source":t.source=n.textContent}}return t}function E(e){for(var t={},a=0,r=e.childNodes.length;r>a;a++){var n=e.childNodes[a];if(1===n.nodeType)switch(n.nodeName){case"constant":case"lambert":case"blinn":case"phong":t.type=n.nodeName,t.parameters=w(n)}}return t}function w(e){for(var t={},a=0,r=e.childNodes.length;r>a;a++){var n=e.childNodes[a];if(1===n.nodeType)switch(n.nodeName){case"emission":case"diffuse":case"specular":case"shininess":case"transparency":t[n.nodeName]=y(n)}}return t}function y(e){for(var t={},a=0,n=e.childNodes.length;n>a;a++){var i=e.childNodes[a];if(1===i.nodeType)switch(i.nodeName){case"color":t[i.nodeName]=r(i.textContent);break;case"float":t[i.nodeName]=parseFloat(i.textContent);break;case"texture":t[i.nodeName]={id:i.getAttribute("texture"),extra:T(i)}}}return t}function T(e){for(var t={},a=0,r=e.childNodes.length;r>a;a++){var n=e.childNodes[a];if(1===n.nodeType)switch(n.nodeName){case"extra":t=A(n)}}return t}function A(e){for(var t={},a=0,r=e.childNodes.length;r>a;a++){var n=e.childNodes[a];if(1===n.nodeType)switch(n.nodeName){case"technique":t[n.nodeName]=C(n)}}return t}function C(e){for(var t={},a=0,r=e.childNodes.length;r>a;a++){var n=e.childNodes[a];if(1===n.nodeType)switch(n.nodeName){case"repeatU":case"repeatV":case"offsetU":case"offsetV":t[n.nodeName]=parseFloat(n.textContent);break;case"wrapU":case"wrapV":t[n.nodeName]=parseInt(n.textContent)}}return t}function x(e){return e}function R(e){return u(fe.effects[e],x)}function k(e){for(var t={name:e.getAttribute("name")},a=0,r=e.childNodes.length;r>a;a++){var n=e.childNodes[a];if(1===n.nodeType)switch(n.nodeName){case"instance_effect":t.url=i(n.getAttribute("url"))}}fe.materials[e.getAttribute("id")]=t}function H(e){function t(e){var t=r.profile.samplers[e.id];if(void 0!==t){var a=r.profile.surfaces[t.source],n=new THREE.Texture(h(a.init_from)),i=e.extra;if(void 0!==i&&void 0!==i.technique){var o=i.technique;n.wrapS=o.wrapU?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,n.wrapT=o.wrapV?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,n.offset.set(o.offsetU,o.offsetV),n.repeat.set(o.repeatU,o.repeatV)}else n.wrapS=THREE.RepeatWrapping,n.wrapT=THREE.RepeatWrapping;return n.needsUpdate=!0,n}return console.error("ColladaLoder: Undefined sampler",e.id),null}var a,r=R(e.url),n=r.profile.technique;switch(n.type){case"phong":case"blinn":a=new THREE.MeshPhongMaterial;break;case"lambert":a=new THREE.MeshLambertMaterial;break;default:a=new THREE.MeshBasicMaterial}a.name=e.name;var i=n.parameters;for(var o in i){var s=i[o];switch(o){case"diffuse":s.color&&a.color.fromArray(s.color),s.texture&&(a.map=t(s.texture));break;case"specular":s.color&&a.specular&&a.specular.fromArray(s.color);break;case"shininess":s["float"]&&a.shininess&&(a.shininess=s["float"]);break;case"emission":s.color&&a.emissive&&a.emissive.fromArray(s.color);break;case"transparency":s["float"]&&(a.opacity=s["float"]),1!==s["float"]&&(a.transparent=!0)}}return a}function _(e){return u(fe.materials[e],H)}function L(e){for(var t={name:e.getAttribute("name")},a=0,r=e.childNodes.length;r>a;a++){var n=e.childNodes[a];if(1===n.nodeType)switch(n.nodeName){case"optics":t.optics=M(n)}}fe.cameras[e.getAttribute("id")]=t}function M(e){for(var t=0;t<e.childNodes.length;t++){var a=e.childNodes[t];switch(a.nodeName){case"technique_common":return O(a)}}return{}}function O(e){for(var t={},a=0;a<e.childNodes.length;a++){var r=e.childNodes[a];switch(r.nodeName){case"perspective":case"orthographic":t.technique=r.nodeName,t.parameters=q(r)}}return t}function q(e){for(var t={},a=0;a<e.childNodes.length;a++){var r=e.childNodes[a];switch(r.nodeName){case"xfov":case"yfov":case"xmag":case"ymag":case"znear":case"zfar":case"aspect_ratio":t[r.nodeName]=parseFloat(r.textContent)}}return t}function P(e){var t;switch(e.optics.technique){case"perspective":t=new THREE.PerspectiveCamera(e.optics.parameters.yfov,e.optics.parameters.aspect_ratio,e.optics.parameters.znear,e.optics.parameters.zfar);break;case"orthographic":t=new THREE.OrthographicCamera;break;default:t=new THREE.PerspectiveCamera}return t.name=e.name,t}function S(e){return u(fe.cameras[e],P)}function U(e){for(var t={},a=0,r=e.childNodes.length;r>a;a++){var n=e.childNodes[a];if(1===n.nodeType)switch(n.nodeName){case"technique_common":t=F(n)}}fe.lights[e.getAttribute("id")]=t}function F(e){for(var t={},a=0,r=e.childNodes.length;r>a;a++){var n=e.childNodes[a];if(1===n.nodeType)switch(n.nodeName){case"directional":case"point":case"spot":case"ambient":t.technique=n.nodeName,t.parameters=D(n)}}return t}function D(e){for(var t={},a=0,n=e.childNodes.length;n>a;a++){var i=e.childNodes[a];if(1===i.nodeType)switch(i.nodeName){case"color":var o=r(i.textContent);t.color=(new THREE.Color).fromArray(o);break;case"falloff_angle":t.falloffAngle=parseFloat(i.textContent);break;case"quadratic_attenuation":var s=parseFloat(i.textContent);t.distance=s?Math.sqrt(1/s):0}}return t}function V(e){var t;switch(e.technique){case"directional":t=new THREE.DirectionalLight;break;case"point":t=new THREE.PointLight;break;case"spot":t=new THREE.SpotLight;break;case"ambient":t=new THREE.AmbientLight}return e.parameters.color&&t.color.copy(e.parameters.color),e.parameters.distance&&(t.distance=e.parameters.distance),t}function G(e){return u(fe.lights[e],V)}function B(e){for(var t={name:e.getAttribute("name"),sources:{},vertices:{},primitives:[]},r=a(e,"mesh")[0],n=0;n<r.childNodes.length;n++){var i=r.childNodes[n];if(1===i.nodeType){var o=i.getAttribute("id");switch(i.nodeName){case"source":t.sources[o]=I(i);break;case"vertices":t.vertices=W(i);break;case"polygons":console.log("ColladaLoader: Unsupported primitive type: ",i.nodeName);break;case"lines":case"linestrips":case"polylist":case"triangles":t.primitives.push(z(i));break;default:console.log(i)}}}fe.geometries[e.getAttribute("id")]=t}function I(e){for(var t={array:[],stride:3},n=0;n<e.childNodes.length;n++){var i=e.childNodes[n];if(1===i.nodeType)switch(i.nodeName){case"float_array":t.array=r(i.textContent);break;case"technique_common":var o=a(i,"accessor")[0];void 0!==o&&(t.stride=parseInt(o.getAttribute("stride")));break;default:console.log(i)}}return t}function W(e){for(var t={},a=0;a<e.childNodes.length;a++){var r=e.childNodes[a];1===r.nodeType&&(t[r.getAttribute("semantic")]=i(r.getAttribute("source")))}return t}function z(e){for(var t={type:e.nodeName,material:e.getAttribute("material"),inputs:{},stride:0},a=0,r=e.childNodes.length;r>a;a++){var o=e.childNodes[a];if(1===o.nodeType)switch(o.nodeName){case"input":var s=i(o.getAttribute("source")),c=o.getAttribute("semantic"),l=parseInt(o.getAttribute("offset"));t.inputs[c]={id:s,offset:l},t.stride=Math.max(t.stride,l+1);break;case"vcount":t.vcount=n(o.textContent);break;case"p":t.p=n(o.textContent)}}return t}function j(e){var t={},a=e.sources,r=e.vertices,n=e.primitives;if(0===n.length)return t;for(var i=0;i<n.length;i++){var o=n[i],s=o.inputs,c=new THREE.BufferGeometry;e.name&&(c.name=e.name);for(var l in s){var d=s[l];switch(l){case"VERTEX":for(var u in r)c.addAttribute(u.toLowerCase(),X(o,a[r[u]],d.offset));break;case"NORMAL":c.addAttribute("normal",X(o,a[d.id],d.offset));break;case"COLOR":c.addAttribute("color",X(o,a[d.id],d.offset));break;case"TEXCOORD":c.addAttribute("uv",X(o,a[d.id],d.offset))}}var f;switch(o.type){case"lines":f=new THREE.LineSegments(c,ne);break;case"linestrips":f=new THREE.Line(c,ne);break;case"triangles":case"polylist":f=new THREE.Mesh(c,ie)}t[o.material]=f}return t}function X(e,t,a){function r(e){for(var t=n[e+a]*l,r=t+l;r>t;t++)d.push(c[t])}var n=e.p,i=e.stride,o=e.vcount,s=0,c=t.array,l=t.stride,d=[];if(void 0!==e.vcount){for(var u=0,f=0,m=o.length;m>f;f++){var h=o[f];if(4===h){var p=u+0*i,v=u+1*i,g=u+2*i,b=u+3*i;r(p),r(v),r(b),r(v),r(g),r(b)}else if(3===h){var p=u+0*i,v=u+1*i,g=u+2*i;r(p),r(v),r(g)}else s=Math.max(s,h);u+=i*h}s>0&&console.log("ColladaLoader: Geometry has faces with more than 4 vertices.")}else for(var f=0,m=n.length;m>f;f+=i)r(f);return new THREE.Float32Attribute(d,l)}function Y(e){return u(fe.geometries[e],j)}function Z(e){for(var t={name:e.getAttribute("name"),matrix:new THREE.Matrix4,nodes:[],instanceCameras:[],instanceLights:[],instanceGeometries:[],instanceNodes:[]},a=0;a<e.childNodes.length;a++){var n=e.childNodes[a];if(1===n.nodeType)switch(n.nodeName){case"node":Z(n),t.nodes.push(n.getAttribute("id"));break;case"instance_camera":t.instanceCameras.push(i(n.getAttribute("url")));break;case"instance_light":t.instanceLights.push(i(n.getAttribute("url")));break;case"instance_geometry":t.instanceGeometries.push(J(n));break;case"instance_node":t.instanceNodes.push(i(n.getAttribute("url")));break;case"matrix":var o=r(n.textContent);t.matrix.multiply(oe.fromArray(o).transpose());break;case"translate":var o=r(n.textContent);se.fromArray(o),t.matrix.multiply(oe.makeTranslation(se.x,se.y,se.z));break;case"rotate":var o=r(n.textContent),s=THREE.Math.degToRad(o[3]);t.matrix.multiply(oe.makeRotationAxis(se.fromArray(o),s));break;case"scale":var o=r(n.textContent);t.matrix.scale(se.fromArray(o));break;case"extra":break;default:console.log(n)}}return null!==e.getAttribute("id")&&(fe.nodes[e.getAttribute("id")]=t),t}function J(e){for(var t={id:i(e.getAttribute("url")),materials:{}},a=0;a<e.childNodes.length;a++){var r=e.childNodes[a];if("bind_material"===r.nodeName){for(var n=r.getElementsByTagName("instance_material"),o=0;o<n.length;o++){var s=n[o],c=s.getAttribute("symbol"),l=s.getAttribute("target");t.materials[c]=i(l)}break}}return t}function K(e){for(var t=[],a=e.matrix,r=e.nodes,n=e.instanceCameras,i=e.instanceLights,o=e.instanceGeometries,s=e.instanceNodes,c=0,l=r.length;l>c;c++)t.push(Q(r[c]).clone());for(var c=0,l=n.length;l>c;c++)t.push(S(n[c]).clone());for(var c=0,l=i.length;l>c;c++)t.push(G(i[c]).clone());for(var c=0,l=o.length;l>c;c++){var d=o[c],u=Y(d.id);for(var f in u){var m=u[f].clone();void 0!==d.materials[f]&&(m.material=_(d.materials[f])),t.push(m)}}for(var c=0,l=s.length;l>c;c++)t.push(Q(s[c]).clone());var m;if(0===r.length&&1===t.length)m=t[0];else{m=new THREE.Group;for(var c=0;c<t.length;c++)m.add(t[c])}return m.name=e.name,a.decompose(m.position,m.quaternion,m.scale),m}function Q(e){return u(fe.nodes[e],K)}function $(e){for(var t={name:e.getAttribute("name"),children:[]},r=a(e,"node"),n=0;n<r.length;n++)t.children.push(Z(r[n]));fe.visualScenes[e.getAttribute("id")]=t}function ee(e){var t=new THREE.Group;t.name=e.name;for(var a=e.children,r=0;r<a.length;r++)t.add(K(a[r]));return t}function te(e){return u(fe.visualScenes[e],ee)}function ae(e){var t=a(e,"instance_visual_scene")[0];return te(i(t.getAttribute("url")))}var re=new THREE.ImageLoader,ne=new THREE.LineBasicMaterial,ie=new THREE.MeshPhongMaterial,oe=new THREE.Matrix4,se=new THREE.Vector3;if(console.time("ColladaLoader"),0===e.length)return{scene:new THREE.Scene};console.time("ColladaLoader: DOMParser");var ce=(new DOMParser).parseFromString(e,"application/xml");console.timeEnd("ColladaLoader: DOMParser");var le=a(ce,"COLLADA")[0],de=le.getAttribute("version");console.log("ColladaLoader: File version",de);var ue=o(a(le,"asset")[0]),fe={images:{},effects:{},materials:{},cameras:{},lights:{},geometries:{},nodes:{},visualScenes:{}};console.time("ColladaLoader: Parse"),l(le,fe.images,"library_images","image",f),l(le,fe.effects,"library_effects","effect",p),l(le,fe.materials,"library_materials","material",k),l(le,fe.cameras,"library_cameras","camera",L),l(le,fe.lights,"library_lights","light",U),l(le,fe.geometries,"library_geometries","geometry",B),l(le,fe.nodes,"library_nodes","node",Z),l(le,fe.visualScenes,"library_visual_scenes","visual_scene",$),console.timeEnd("ColladaLoader: Parse"),console.time("ColladaLoader: Build"),d(fe.images,m),d(fe.effects,x),d(fe.materials,H),d(fe.cameras,P),d(fe.lights,V),d(fe.geometries,j),d(fe.nodes,K),d(fe.visualScenes,ee),console.timeEnd("ColladaLoader: Build");var me=ae(a(le,"scene")[0]);return"Z_UP"===ue.upAxis&&(me.rotation.x=-Math.PI/2),me.scale.multiplyScalar(ue.unit),console.timeEnd("ColladaLoader"),{animations:[],kinematics:{joints:[]},scene:me}}};