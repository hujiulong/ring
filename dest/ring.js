var Ring=new function(){function e(e,t,o,i,r){M=document.getElementById(r),null===M&&(M=document.createElement("div"),M.id=r,document.body.appendChild(M)),C=M.offsetWidth,V=M.offsetHeight,d(),T(),n(e,t,o,i),l(c)}function t(e,t){switch(e){case"models":return D.model+t+".js";case"font":return D.font+t+".json";case"shape":return D.shape+t.substring(1,t.length-1)+".js"}return null}function n(e,n,o,i){j=a(n),A.materialName=n,A.fontName=i,A.text=e,A.modelUrl=t("models",o),p(e)?(A.type="shape",A.shapeUrl=t("shape",e),A.fontUrl=t("font",i)):(A.type="text",A.fontUrl=t("font",i)),"9-1"==o?"text"==A.type&&(A.rotationCalibrated.set(0,0,0),A.positionCalibrated.set(0,0,0),A.cutFlag=!0):"9-2"==o?("text"==A.type?(A.rotationCalibrated.set(0,0,0),A.positionCalibrated.set(0,0,0),A.cutFlag=!0):"shape"==A.type&&(A.rotationCalibrated.set(0,0,0),A.positionCalibrated.set(0,0,-20)),A.cutFlag=!0):"9-3"==o?"text"==A.type&&(A.textHeight=150,A.rotationCalibrated.set(0,0,6/180*Math.PI),A.positionCalibrated.set(0,37,0),A.cutFlag=!1):"9-4"==o?"text"==A.type&&(A.rotationCalibrated.set(0,0,0),A.positionCalibrated.set(-5,0,-20),A.cutFlag=!0):"9-5"==o?"text"==A.type&&(A.rotationCalibrated.set(0,0,0),A.positionCalibrated.set(0,0,0),A.cutFlag=!0,A.depth=50):(A.rotationCalibrated.set(0,0,0),A.positionCalibrated.set(0,0,0),A.cutFlag=!0)}function o(e,o){if("text"==e)G.remove(P),G.remove(N),S.remove(G),G=new THREE.Object3D,A.text=o,p(A.text)?(A.type="shape",A.shapeUrl=t("shape",A.text),null==O.shapeGeometry&&s(A.shapeUrl,c)):(A.type="text",c());else if("height"==e)console.log(o/A.height),G.scale.y=o/A.height;else if("material"==e)for(var i=a(o),r=0;r<G.children.length;r++)G.children[r].material=i;else if("model"==e){n(A.text,A.materialName,o,A.fontName),G.remove(P),G.remove(N),S.remove(G),G=new THREE.Object3D,A.modelUrl="models/"+o+".js";var l=new THREE.JSONLoader;l.load(A.modelUrl,function(e,t){O.ringGeometry=e.clone(),c(e)})}}function i(e){switch(e){case"text":return A.text;case"height":return A.height}}function r(e,t){var n=new THREE.MeshPhongMaterial(e);return n.name=t,n}function a(e){for(var t=0;t<I.length;t++)if(I[t].name==e)return I[t];return I[0]}function l(e){function t(){o.load(A.fontUrl,function(t){n=t,O.font=n,i.load(A.modelUrl,function(t,n){O.ringGeometry=t.clone(),e()})})}var n,o=new THREE.FontLoader,i=new THREE.JSONLoader;"shape"==A.type?i.load(A.shapeUrl,function(e,n){O.shapeGeometry=e,t()}):"text"==A.type&&t()}function s(e,t){var e,n=new THREE.JSONLoader;"shape"==A.type?e=A.shapeUrl:"text"==A.type&&(e=A.modelUrl),n.load(e,function(e,n){"shape"==A.type?O.shapeGeometry=e:"text"==A.type&&(O.ringGeometry=e),t()})}function c(){console.log("load "+((new Date).getTime()-B)+"ms"),"shape"==A.type?N=x():"text"==A.type&&(N=w(A.text,O.font)),P=g()}function d(){z=new THREE.PerspectiveCamera(45,C/V,1,1e4),z.position.set(0,700,2800),U=new THREE.OrbitControls(z,M),U.enableDamping=!0,U.dampingFactor=.15,U.minDistance=100,U.maxDistance=3500,U.rotateSpeed=.15,S=new THREE.Scene,e=new THREE.DirectionalLight(16777190,.95),e.position.set(0,100,200),S.add(e),e=new THREE.DirectionalLight(16777190,.75),e.position.set(0,-100,-200),S.add(e);var e=new THREE.HemisphereLight(13365758,16773846,.4);S.add(e);var e=new THREE.AmbientLight(4210752);S.add(e),F=new THREE.WebGLRenderer({antialias:!0}),F.setPixelRatio(window.devicePixelRatio),F.setClearColor(16777215),F.setSize(C,V),M.appendChild(F.domElement),L=new Stats,L.domElement.style.position="absolute",L.domElement.style.top="0px",L.domElement.style.zIndex=100,M.appendChild(L.domElement),window.addEventListener("resize",v,!1)}function g(){function e(e,t,n){return!!(A.cutFlag&&e.distanceToPoint(n)>0&&t.distanceToPoint(n)>0)}var t,n=O.ringGeometry.clone(),o=new THREE.Vector3,i=[],r=[],a=[],l=[],s=(new THREE.Matrix4).makeRotationX(-Math.PI/2).multiply((new THREE.Matrix4).makeScale(50,50,50));n.applyMatrix(s),n.verticesNeedUpdate=!0,n.computeBoundingBox(),t=(n.boundingBox.max.x-n.boundingBox.min.x)/2,o.set(t+n.boundingBox.min.x,0,t+n.boundingBox.min.z),A.height=n.boundingBox.max.y-n.boundingBox.min.y;var c=(N.width/2-7)/(t+N.depth/2),d=(new THREE.Vector3).crossVectors(new THREE.Vector3(0,0,1).applyAxisAngle(new THREE.Vector3(0,1,0),c).normalize(),new THREE.Vector3(0,1,1).applyAxisAngle(new THREE.Vector3(0,1,0),c).normalize()),g=(new THREE.Vector3).crossVectors(new THREE.Vector3(0,0,1).applyAxisAngle(new THREE.Vector3(0,1,0),-c).normalize(),new THREE.Vector3(0,1,1).applyAxisAngle(new THREE.Vector3(0,1,0),-c).normalize()),h=new THREE.Plane;h.setFromNormalAndCoplanarPoint(d.normalize(),o);var p=new THREE.Plane;p.setFromNormalAndCoplanarPoint(g.normalize().negate(),o);for(var E=0;E<n.faces.length;E++){var x=n.faces[E],w=n.vertices[x.a],y=n.vertices[x.b],f=n.vertices[x.c],R=[w,y,f],v=[0,0,0],T=[],H=[];e(h,p,w)&&(v[0]=1),e(h,p,y)&&(v[1]=1),e(h,p,f)&&(v[2]=1);for(var M=0;M<v.length;M++)v[M]?H.push(R[M]):T.push(R[M]);if(0==H.length)i.push(w,y,f),r.push(new THREE.Face3(i.length-1,i.length-2,i.length-3));else if(1==H.length){var L,C,V=new THREE.Line3(H[0],T[0]),z=new THREE.Line3(H[0],T[1]),U=1,F=1;void 0!=(L=h.intersectLine(V))?U=1:(L=p.intersectLine(V),U=2),void 0!=(C=h.intersectLine(z))?F=1:(C=p.intersectLine(z),F=2),i.push(T[0],T[1],L,C);var D=u(i[i.length-1].clone(),o,t-20).sub(L.clone());r.push(m(i,i.length-1,i.length-2,i.length-3,D)),r.push(m(i,i.length-2,i.length-3,i.length-4,D)),1==U?a.push(i.length-2):l.push(i.length-2),1==F?a.push(i.length-1):l.push(i.length-1)}else if(2==H.length){var L,C,V=new THREE.Line3(T[0],H[0]),z=new THREE.Line3(T[0],H[1]),U=1,F=1;void 0!=(L=h.intersectLine(V))?U=1:(L=p.intersectLine(V),U=2),void 0!=(C=h.intersectLine(z))?F=1:(C=p.intersectLine(z),F=2),i.push(T[0],L,C);var D=u(i[i.length-1].clone(),o,t-20).sub(L.clone());r.push(m(i,i.length-1,i.length-2,i.length-3,D)),1==U?a.push(i.length-2):l.push(i.length-2),1==F?a.push(i.length-1):l.push(i.length-1)}}var I=new THREE.Geometry;I.vertices=i,I.faces=r;var k=[],W=[],J=new THREE.Geometry;A.cutFlag&&a.length>0&&l.length>0&&k.push(i[a[0]],i[l[0]]);for(var D=new THREE.Vector3(0,0,(-1)),E=2;E<a.length;E++)k.push(i[a[E-1]],i[a[E]]),W.push(m(k,0,k.length-1,k.length-2,D));for(var E=2;E<l.length;E++)k.push(i[l[E-1]],i[l[E]]),W.push(m(k,1,k.length-1,k.length-2,D));J.vertices=k,J.faces=W,J.mergeVertices(),J.computeFaceNormals(),J.computeVertexNormals(),I.mergeVertices(),I.computeFaceNormals(),I.computeVertexNormals(),I.merge(J),P=new THREE.Mesh(I,j),S.add(P),G.add(P),N=b(o,t,N),N.position.copy(A.positionCalibrated),N.position.y-=A.textHeight/2,N.rotation.copy(A.rotationCalibrated),G.add(N),S.add(G),console.log("total "+((new Date).getTime()-B)+"ms")}function m(e,t,n,o,i){var r=h(e[t].clone(),e[n].clone(),e[o].clone());return i.angleTo(r)<=Math.PI/2?new THREE.Face3(t,n,o):new THREE.Face3(o,n,t)}function h(e,t,n){var o=new THREE.Vector3,i=new THREE.Vector3;return o.subVectors(n,t),i.subVectors(e,t),o.cross(i),o.normalize()}function u(e,t,n){var o=e.sub(t.clone().setY(e.y));return o.setLength(n)}function p(e){var t=/\[\S+\]/g;return t.test(e)}function E(e){return e>="A"&&e<="Z"||"p"==e||"s"==e||"1"==e}function x(){var e=O.shapeGeometry.clone(),t=new THREE.Mesh(e,j);return t.geometry.applyMatrix((new THREE.Matrix4).makeScale(50,50,50)),t.geometry.computeBoundingBox(),t.width=t.geometry.boundingBox.max.x-t.geometry.boundingBox.min.x,t.height=t.geometry.boundingBox.max.y-t.geometry.boundingBox.min.y,t.depth=t.geometry.boundingBox.max.z-t.geometry.boundingBox.min.z,t.geometry.applyMatrix((new THREE.Matrix4).setPosition(new THREE.Vector3(t.width/2,t.height/2,t.depth/2))),t}function w(e,t){for(var n,e=A.text,o=0,i=0,r=0;r<e.length;r++)E(e[r])||r==e.length-1?(i&&(i=0,n=f(n,e.substring(o,r))),n=f(n,e[r])):i||(i=1,o=r);return n.geometry.computeBoundingBox(),n.width=n.geometry.boundingBox.max.x-n.geometry.boundingBox.min.x,n.height=n.geometry.boundingBox.max.y-n.geometry.boundingBox.min.y,n.depth=n.geometry.boundingBox.max.z-n.geometry.boundingBox.min.z,n}function y(e){return new THREE.TextGeometry(e,{size:A.textHeight,height:A.depth,curveSegments:5,font:O.font,weight:"bold",style:"normal",bevelEnabled:!0,bevelThickness:2,bevelSize:1})}function f(e,t,n){if(void 0===e)return new THREE.Mesh(y(t,n),j);e.geometry.computeBoundingBox();var o=e.geometry.clone(),i=y(t,n);o.computeBoundingBox(),i.computeBoundingBox();var r=o.boundingBox.max.x-o.boundingBox.min.x,a=i.boundingBox.max.x-o.boundingBox.min.x,l=i.boundingBox.max.y-o.boundingBox.min.y,s=!1,c=new THREE.Vector3(r,0,0);do{for(var d=c.clone().add(new THREE.Vector3(a/2,l/2,0)),g=0;g<i.vertices.length;g++)if(!(i.vertices[g].z!=d.z||i.vertices[g].x>=a/2)){var m=i.vertices[g].clone(),h=m.sub(new THREE.Vector3(a/2,l/2,0)),u=new THREE.Raycaster(d,h.clone().normalize()),p=u.intersectObject(e);if(p.length>0&&p[0].distance<h.length()){s=!0,o.merge(i,(new THREE.Matrix4).setPosition(c));break}}c.x-=3}while(!s);return new THREE.Mesh(o,j)}function b(e,t,n){var o=(new THREE.Matrix4).setPosition(new THREE.Vector3(-n.width/2,0,0));n.geometry.applyMatrix(o);for(var i=t+n.depth/2,r=2*i*Math.PI,a=0;a<n.geometry.vertices.length;a++){var l=n.geometry.vertices[a].clone(),s=t-l.z,c=l.x,d=c/r*Math.PI*2;n.geometry.vertices[a].set(s*Math.sin(d),l.y,s*Math.cos(d)).add(e)}return n.geometry.verticesNeedUpdate=!0,n.geometry.mergeVertices(),n.geometry.computeFaceNormals(),n.geometry.computeVertexNormals(),n}function R(e){var t;if(e=e.toLowerCase(),window.URL=window.URL||window.webkitURL,window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder,"obj"==e){var n=new THREE.OBJExporter;t=n.parse(S)}else if("stl"==e){var n=new THREE.STLExporter;t=n.parse(S)}var o=document.createElement("a");o.style.display="none",document.body.appendChild(o),o.href=URL.createObjectURL(new Blob([t],{type:"text/plain"})),o.download="model."+e,o.click()}function v(){z.aspect=window.innerWidth/window.innerHeight,z.updateProjectionMatrix(),F.setSize(window.innerWidth,window.innerHeight)}function T(){requestAnimationFrame(T),H()}function H(){L.update(),U.update(),F.render(S,z)}var B=(new Date).getTime();Detector.webgl||Detector.addGetWebGLMessage();var M,L,C,V,z,U,S,F,N,P,j,G=new THREE.Object3D,D={font:"fonts/",model:"models/",shape:"models/"},A={text:"hello",depth:70,height:0,type:"text",textHeight:158,shapeUrl:"",modelUrl:"",fontUrl:"",materialName:"gold_yellow",fontName:"",positionCalibrated:new THREE.Vector3(0,0,0),rotationCalibrated:new THREE.Euler(0,0,0),cutFlag:!0},O={font:null,shapeGeometry:null,ringGeometry:null},I=[],k=["img/px.jpg","img/nx.jpg","img/py.jpg","img/ny.jpg","img/pz.jpg","img/nz.jpg"],W=THREE.ImageUtils.loadTextureCube(k);return W.format=THREE.RGBFormat,I.push(r({color:16764482,specular:3355443,combine:THREE.MixOperation,envMap:W,shininess:54,reflectivity:.75,side:THREE.DoubleSide,shading:THREE.SmoothShading},"gold_yellow")),I.push(r({color:16750995,specular:3355443,combine:THREE.MixOperation,envMap:W,shininess:54,reflectivity:.75,side:THREE.DoubleSide,shading:THREE.SmoothShading},"gold_red")),I.push(r({color:16777215,specular:16777215,combine:THREE.MixOperation,envMap:W,shininess:54,reflectivity:.75,side:THREE.DoubleSide,shading:THREE.SmoothShading},"silver")),{init:function(t,n,o,i,r){return t.length>13?void alert("文字太长"):void e(t,n,o,i,r)},change:function(e,t){o(e,t)},get:function(e){return i(e)},"export":function(e){R(e)}}};