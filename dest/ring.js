var Ring=new function(){function e(e,n,o,i){t(e,n,o,i),a(l)}function t(e,t,n,o){B=r(t),C.materialName=t,C.fontName=o,C.text=e,C.modelUrl="models/"+n+".js",C.fontUrl="fonts/"+o+".json","9-1"==n?(C.rotationCalibrated.set(0,0,0),C.positionCalibrated.set(0,0,0),C.cutFlag=!0):"9-2"==n?(C.rotationCalibrated.set(0,0,0),C.positionCalibrated.set(0,0,0),C.cutFlag=!0):"9-3"==n?(C.textHeight=150,C.rotationCalibrated.set(0,0,6/180*Math.PI),C.positionCalibrated.set(0,37,0),C.cutFlag=!1):"9-4"==n?(C.rotationCalibrated.set(0,0,0),C.positionCalibrated.set(-5,0,-20),C.cutFlag=!0):"9-5"==n&&(C.rotationCalibrated.set(0,0,0),C.positionCalibrated.set(0,0,0),C.cutFlag=!0,C.depth=50)}function n(e,n){if("text"==e)C.text=n,M.remove(y),M.remove(b),v.remove(M),M=new THREE.Object3D,l(z.font,z.ringGeometry.clone());else if("height"==e)console.log(n/C.height),M.scale.y=n/C.height;else if("material"==e){var o=r(n);M.children[0].material=o,M.children[1].material=o}else if("model"==e){t(C.text,C.materialName,n,C.fontName),M.remove(y),M.remove(b),v.remove(M),M=new THREE.Object3D,C.modelUrl="models/"+n+".js";var i=new THREE.JSONLoader;i.load(C.modelUrl,function(e,t){z.ringGeometry=e.clone(),l(z.font,e)})}}function o(e){switch(e){case"text":return C.text;case"height":return C.height}}function i(e,t){var n=new THREE.MeshPhongMaterial(e);return n.name=t,n}function r(e){for(var t=0;t<F.length;t++)if(F[t].name==e)return F[t];return F[0]}function a(e){var t,n=new THREE.FontLoader,o=new THREE.JSONLoader;n.load(C.fontUrl,function(n){t=n,z.font=t,o.load(C.modelUrl,function(n,o){z.ringGeometry=n.clone(),e(t,n)})})}function l(e,t){b=g(C.text,e),y=d(t)}function s(){R=new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,1,1e4),R.position.set(0,0,2e3),x=document.getElementById("container"),T=new THREE.TrackballControls(R,x),T.rotateSpeed=1,T.zoomSpeed=1.2,T.panSpeed=.8,T.noZoom=!1,T.noPan=!1,T.staticMoving=!0,T.dynamicDampingFactor=.3,v=new THREE.Scene,e=new THREE.DirectionalLight(16777190,.95),e.position.set(0,100,200),v.add(e),e=new THREE.DirectionalLight(16777190,.75),e.position.set(0,-100,-200),v.add(e);var e=new THREE.HemisphereLight(13365758,16773846,.4);v.add(e);var e=new THREE.AmbientLight(4210752);v.add(e),f=new THREE.WebGLRenderer({antialias:!0}),f.setPixelRatio(window.devicePixelRatio),f.setClearColor(16777215),f.setSize(window.innerWidth,window.innerHeight),x.appendChild(f.domElement),H=new Stats,H.domElement.style.position="absolute",H.domElement.style.top="0px",H.domElement.style.zIndex=100,x.appendChild(H.domElement),window.addEventListener("resize",u,!1)}function d(e){function t(e,t,n){return!!(C.cutFlag&&e.distanceToPoint(n)>0&&t.distanceToPoint(n)>0)}var n,o=new THREE.Vector3,i=[],r=[],a=[],l=[],s=(new THREE.Matrix4).makeRotationX(-Math.PI/2).multiply((new THREE.Matrix4).makeScale(50,50,50));e.applyMatrix(s),e.verticesNeedUpdate=!0,e.computeBoundingBox(),n=(e.boundingBox.max.x-e.boundingBox.min.x)/2,o.set(n+e.boundingBox.min.x,0,n+e.boundingBox.min.z),C.height=e.boundingBox.max.y-e.boundingBox.min.y;var d=(b.width/2-7)/(n+b.depth/2),c=(new THREE.Vector3).crossVectors(new THREE.Vector3(0,0,1).applyAxisAngle(new THREE.Vector3(0,1,0),d).normalize(),new THREE.Vector3(0,1,1).applyAxisAngle(new THREE.Vector3(0,1,0),d).normalize()),g=(new THREE.Vector3).crossVectors(new THREE.Vector3(0,0,1).applyAxisAngle(new THREE.Vector3(0,1,0),-d).normalize(),new THREE.Vector3(0,1,1).applyAxisAngle(new THREE.Vector3(0,1,0),-d).normalize()),E=new THREE.Plane;E.setFromNormalAndCoplanarPoint(c.normalize(),o);var h=new THREE.Plane;h.setFromNormalAndCoplanarPoint(g.normalize().negate(),o);for(var u=0;u<e.faces.length;u++){var p=e.faces[u],w=e.vertices[p.a],x=e.vertices[p.b],H=e.vertices[p.c],R=[w,x,H],T=[0,0,0],f=[],z=[];t(E,h,w)&&(T[0]=1),t(E,h,x)&&(T[1]=1),t(E,h,H)&&(T[2]=1);for(var F=0;F<T.length;F++)T[F]?z.push(R[F]):f.push(R[F]);if(0==z.length)i.push(w,x,H),r.push(new THREE.Face3(i.length-1,i.length-2,i.length-3));else if(1==z.length){var L,V,S=new THREE.Line3(z[0],f[0]),P=new THREE.Line3(z[0],f[1]),N=1,j=1;void 0!=(L=E.intersectLine(S))?N=1:(L=h.intersectLine(S),N=2),void 0!=(V=E.intersectLine(P))?j=1:(V=h.intersectLine(P),j=2),i.push(f[0],f[1],L,V),r.push(new THREE.Face3(i.length-1,i.length-3,i.length-4)),r.push(new THREE.Face3(i.length-2,i.length-3,i.length-4)),r.push(new THREE.Face3(i.length-1,i.length-2,i.length-4)),1==N?a.push(i.length-2):l.push(i.length-2),1==j?a.push(i.length-1):l.push(i.length-1)}else if(2==z.length){var L,V,S=new THREE.Line3(f[0],z[0]),P=new THREE.Line3(f[0],z[1]),N=1,j=1;void 0!=(L=E.intersectLine(S))?N=1:(L=h.intersectLine(S),N=2),void 0!=(V=E.intersectLine(P))?j=1:(V=h.intersectLine(P),j=2),i.push(f[0],L,V),r.push(new THREE.Face3(i.length-1,i.length-2,i.length-3)),1==N?a.push(i.length-2):l.push(i.length-2),1==j?a.push(i.length-1):l.push(i.length-1)}}for(var u=2;u<a.length;u++)r.push(new THREE.Face3(a[0],a[u],a[u-1]));for(var u=2;u<l.length;u++)r.push(new THREE.Face3(l[0],l[u],l[u-1]));var A=new THREE.Geometry;A.vertices=i,A.faces=r,A.mergeVertices(),A.computeFaceNormals(),A.computeVertexNormals(),y=new THREE.Mesh(A,B),v.add(y),M.add(y),b=m(o,n,b),b.position.copy(C.positionCalibrated),b.position.y-=C.textHeight/2,b.rotation.copy(C.rotationCalibrated),M.add(b),v.add(M),console.log(M)}function c(e){return e>="A"&&e<="Z"||"p"==e||"s"==e||"1"==e}function g(e,t){for(var n,o=0,i=0,r=0;r<e.length;r++)c(e[r])||r==e.length-1?(i&&(i=0,n=h(n,e.substring(o,r),t)),n=h(n,e[r],t)):i||(i=1,o=r);return n.geometry.computeBoundingBox(),n.width=n.geometry.boundingBox.max.x-n.geometry.boundingBox.min.x,n.height=n.geometry.boundingBox.max.y-n.geometry.boundingBox.min.y,n.depth=n.geometry.boundingBox.max.z-n.geometry.boundingBox.min.z,n}function E(e,t){return new THREE.TextGeometry(e,{size:C.textHeight,height:C.depth,curveSegments:4,font:t,weight:"bold",style:"normal",bevelEnabled:!0,bevelThickness:2,bevelSize:1})}function h(e,t,n){if(void 0===e)return new THREE.Mesh(E(t,n),B);e.geometry.computeBoundingBox();var o=e.geometry.clone(),i=E(t,n);o.computeBoundingBox(),i.computeBoundingBox();var r=o.boundingBox.max.x-o.boundingBox.min.x,a=i.boundingBox.max.x-o.boundingBox.min.x,l=i.boundingBox.max.y-o.boundingBox.min.y,s=!1,d=new THREE.Vector3(r,0,0);do{for(var c=d.clone().add(new THREE.Vector3(a/2,l/2,0)),g=0;g<i.vertices.length;g++)if(!(i.vertices[g].z!=c.z||i.vertices[g].x>=a/2)){var h=i.vertices[g].clone(),m=h.sub(new THREE.Vector3(a/2,l/2,0)),u=new THREE.Raycaster(c,m.clone().normalize()),p=u.intersectObject(e);if(p.length>0&&p[0].distance<m.length()){s=!0,o.merge(i,(new THREE.Matrix4).setPosition(d));break}}d.x-=3}while(!s);return new THREE.Mesh(o,B)}function m(e,t,n){var o=(new THREE.Matrix4).setPosition(new THREE.Vector3(-n.width/2,0,0));n.geometry.applyMatrix(o);for(var i=t+n.depth/2,r=2*i*Math.PI,a=0;a<n.geometry.vertices.length;a++){var l=n.geometry.vertices[a],s=t-l.z,d=l.x,c=d/r*Math.PI*2;n.geometry.vertices[a].set(s*Math.sin(c),l.y,s*Math.cos(c)).add(e)}return n.geometry.verticesNeedUpdate=!0,n.geometry.mergeVertices(),n.geometry.computeFaceNormals(),n.geometry.computeVertexNormals(),n}function u(){R.aspect=window.innerWidth/window.innerHeight,R.updateProjectionMatrix(),f.setSize(window.innerWidth,window.innerHeight)}function p(){requestAnimationFrame(p),w()}function w(){H.update(),T.update(),f.render(v,R)}(new Date).getTime();Detector.webgl||Detector.addGetWebGLMessage();var x,H,R,T,v,f,b,y,B,M=new THREE.Object3D,C={text:"hello",depth:70,height:0,textHeight:158,modelUrl:"",fontUrl:"",materialName:"gold_yellow",fontName:"",positionCalibrated:new THREE.Vector3(0,0,0),rotationCalibrated:new THREE.Euler(0,0,0),cutFlag:!0},z={font:null,ringGeometry:null,textMesh:null},F=[],L=["img/px.jpg","img/nx.jpg","img/py.jpg","img/ny.jpg","img/pz.jpg","img/nz.jpg"],V=THREE.ImageUtils.loadTextureCube(L);return V.format=THREE.RGBFormat,F.push(i({color:16764482,specular:3355443,combine:THREE.MixOperation,envMap:V,shininess:54,reflectivity:.75,side:THREE.DoubleSide,shading:THREE.SmoothShading},"gold_yellow")),F.push(i({color:16750995,specular:3355443,combine:THREE.MixOperation,envMap:V,shininess:54,reflectivity:.75,side:THREE.DoubleSide,shading:THREE.SmoothShading},"gold_red")),F.push(i({color:16777215,specular:16777215,combine:THREE.MixOperation,envMap:V,shininess:54,reflectivity:.75,side:THREE.DoubleSide,shading:THREE.SmoothShading},"silver")),s(),p(),{init:function(t,n,o,i){return t.length>13?void alert("文字太长"):void e(t,n,o,i)},change:function(e,t){n(e,t)},get:function(e){return o(e)}}};