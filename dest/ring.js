var Ring=new function(){function e(e,n,o,i){t(e,n,o,i),a(l)}function t(e,t,n,o){C=r(t),S.materialName=t,S.fontName=o,S.text=e,S.modelUrl="models/"+n+".js",g(e)?(S.type="shape",S.shapeUrl="models/"+e.substring(1,e.length-1)+".js",S.fontUrl="fonts/"+o+".json"):(S.type="text",S.fontUrl="fonts/"+o+".json"),"9-1"==n?"text"==S.type&&(S.rotationCalibrated.set(0,0,0),S.positionCalibrated.set(0,0,0),S.cutFlag=!0):"9-2"==n?("text"==S.type?(S.rotationCalibrated.set(0,0,0),S.positionCalibrated.set(0,0,0),S.cutFlag=!0):"shape"==S.type&&(S.rotationCalibrated.set(0,0,0),S.positionCalibrated.set(0,0,-20)),S.cutFlag=!0):"9-3"==n?"text"==S.type&&(S.textHeight=150,S.rotationCalibrated.set(0,0,6/180*Math.PI),S.positionCalibrated.set(0,37,0),S.cutFlag=!1):"9-4"==n?"text"==S.type&&(S.rotationCalibrated.set(0,0,0),S.positionCalibrated.set(-5,0,-20),S.cutFlag=!0):"9-5"==n&&"text"==S.type&&(S.rotationCalibrated.set(0,0,0),S.positionCalibrated.set(0,0,0),S.cutFlag=!0,S.depth=50)}function n(e,n){if("text"==e)S.text=n,g(S.text)?S.type="shape":S.type="text",z.remove(L),z.remove(M),f.remove(z),z=new THREE.Object3D,l(F.ringGeometry.clone());else if("height"==e)console.log(n/S.height),z.scale.y=n/S.height;else if("material"==e){var o=r(n);z.children[0].material=o,z.children[1].material=o}else if("model"==e){t(S.text,S.materialName,n,S.fontName),z.remove(L),z.remove(M),f.remove(z),z=new THREE.Object3D,S.modelUrl="models/"+n+".js";var i=new THREE.JSONLoader;i.load(S.modelUrl,function(e,t){F.ringGeometry=e.clone(),l(e)})}}function o(e){switch(e){case"text":return S.text;case"height":return S.height}}function i(e,t){var n=new THREE.MeshPhongMaterial(e);return n.name=t,n}function r(e){for(var t=0;t<V.length;t++)if(V[t].name==e)return V[t];return V[0]}function a(e){function t(){o.load(S.fontUrl,function(t){n=t,F.font=n,i.load(S.modelUrl,function(t,n){F.ringGeometry=t.clone(),e(t)})})}var n,o=new THREE.FontLoader,i=new THREE.JSONLoader;"shape"==S.type?i.load(S.shapeUrl,function(e,n){F.shapeGeometry=e,t()}):"text"==S.type&&t()}function l(e){"shape"==S.type?M=m(F.shapeGeometry.clone()):"text"==S.type&&(M=h(S.text,F.font)),L=d(e)}function s(){b=new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,1,1e4),b.position.set(0,0,2e3),H=document.getElementById("container"),v=new THREE.TrackballControls(b,H),v.rotateSpeed=1,v.zoomSpeed=1.2,v.panSpeed=.8,v.noZoom=!1,v.noPan=!1,v.staticMoving=!0,v.dynamicDampingFactor=.3,f=new THREE.Scene,e=new THREE.DirectionalLight(16777190,.95),e.position.set(0,100,200),f.add(e),e=new THREE.DirectionalLight(16777190,.75),e.position.set(0,-100,-200),f.add(e);var e=new THREE.HemisphereLight(13365758,16773846,.4);f.add(e);var e=new THREE.AmbientLight(4210752);f.add(e),B=new THREE.WebGLRenderer({antialias:!0}),B.setPixelRatio(window.devicePixelRatio),B.setClearColor(16777215),B.setSize(window.innerWidth,window.innerHeight),H.appendChild(B.domElement),T=new Stats,T.domElement.style.position="absolute",T.domElement.style.top="0px",T.domElement.style.zIndex=100,H.appendChild(T.domElement),window.addEventListener("resize",x,!1)}function d(e){function t(e,t,n){return!!(S.cutFlag&&e.distanceToPoint(n)>0&&t.distanceToPoint(n)>0)}var n,o=new THREE.Vector3,i=[],r=[],a=[],l=[],s=(new THREE.Matrix4).makeRotationX(-Math.PI/2).multiply((new THREE.Matrix4).makeScale(50,50,50));e.applyMatrix(s),e.verticesNeedUpdate=!0,e.computeBoundingBox(),n=(e.boundingBox.max.x-e.boundingBox.min.x)/2,o.set(n+e.boundingBox.min.x,0,n+e.boundingBox.min.z),S.height=e.boundingBox.max.y-e.boundingBox.min.y;var d=(M.width/2-7)/(n+M.depth/2),g=(new THREE.Vector3).crossVectors(new THREE.Vector3(0,0,1).applyAxisAngle(new THREE.Vector3(0,1,0),d).normalize(),new THREE.Vector3(0,1,1).applyAxisAngle(new THREE.Vector3(0,1,0),d).normalize()),c=(new THREE.Vector3).crossVectors(new THREE.Vector3(0,0,1).applyAxisAngle(new THREE.Vector3(0,1,0),-d).normalize(),new THREE.Vector3(0,1,1).applyAxisAngle(new THREE.Vector3(0,1,0),-d).normalize()),m=new THREE.Plane;m.setFromNormalAndCoplanarPoint(g.normalize(),o);var h=new THREE.Plane;h.setFromNormalAndCoplanarPoint(c.normalize().negate(),o);for(var E=0;E<e.faces.length;E++){var p=e.faces[E],w=e.vertices[p.a],x=e.vertices[p.b],y=e.vertices[p.c],R=[w,x,y],H=[0,0,0],T=[],b=[];t(m,h,w)&&(H[0]=1),t(m,h,x)&&(H[1]=1),t(m,h,y)&&(H[2]=1);for(var v=0;v<H.length;v++)H[v]?b.push(R[v]):T.push(R[v]);if(0==b.length)i.push(w,x,y),r.push(new THREE.Face3(i.length-1,i.length-2,i.length-3));else if(1==b.length){var B,F,V=new THREE.Line3(b[0],T[0]),U=new THREE.Line3(b[0],T[1]),P=1,j=1;void 0!=(B=m.intersectLine(V))?P=1:(B=h.intersectLine(V),P=2),void 0!=(F=m.intersectLine(U))?j=1:(F=h.intersectLine(U),j=2),i.push(T[0],T[1],B,F),r.push(new THREE.Face3(i.length-1,i.length-3,i.length-4)),r.push(new THREE.Face3(i.length-2,i.length-3,i.length-4)),r.push(new THREE.Face3(i.length-1,i.length-2,i.length-4)),1==P?a.push(i.length-2):l.push(i.length-2),1==j?a.push(i.length-1):l.push(i.length-1)}else if(2==b.length){var B,F,V=new THREE.Line3(T[0],b[0]),U=new THREE.Line3(T[0],b[1]),P=1,j=1;void 0!=(B=m.intersectLine(V))?P=1:(B=h.intersectLine(V),P=2),void 0!=(F=m.intersectLine(U))?j=1:(F=h.intersectLine(U),j=2),i.push(T[0],B,F),r.push(new THREE.Face3(i.length-1,i.length-2,i.length-3)),1==P?a.push(i.length-2):l.push(i.length-2),1==j?a.push(i.length-1):l.push(i.length-1)}}for(var E=2;E<a.length;E++)r.push(new THREE.Face3(a[0],a[E],a[E-1]));for(var E=2;E<l.length;E++)r.push(new THREE.Face3(l[0],l[E],l[E-1]));var N=new THREE.Geometry;N.vertices=i,N.faces=r,N.mergeVertices(),N.computeFaceNormals(),N.computeVertexNormals(),L=new THREE.Mesh(N,C),f.add(L),z.add(L),M=u(o,n,M),M.position.copy(S.positionCalibrated),M.position.y-=S.textHeight/2,M.rotation.copy(S.rotationCalibrated),z.add(M),f.add(z),console.log(z)}function g(e){var t=/\[\S+\]/g;return t.test(e)}function c(e){return e>="A"&&e<="Z"||"p"==e||"s"==e||"1"==e}function m(e){var t=new THREE.Mesh(e,C);return t.geometry.applyMatrix((new THREE.Matrix4).makeScale(50,50,50)),t.geometry.computeBoundingBox(),t.width=t.geometry.boundingBox.max.x-t.geometry.boundingBox.min.x,t.height=t.geometry.boundingBox.max.y-t.geometry.boundingBox.min.y,t.depth=t.geometry.boundingBox.max.z-t.geometry.boundingBox.min.z,t.geometry.applyMatrix((new THREE.Matrix4).setPosition(new THREE.Vector3(t.width/2,t.height/2,t.depth/2))),t}function h(e,t){for(var n,o=0,i=0,r=0;r<e.length;r++)c(e[r])||r==e.length-1?(i&&(i=0,n=p(n,e.substring(o,r),t)),n=p(n,e[r],t)):i||(i=1,o=r);return n.geometry.computeBoundingBox(),n.width=n.geometry.boundingBox.max.x-n.geometry.boundingBox.min.x,n.height=n.geometry.boundingBox.max.y-n.geometry.boundingBox.min.y,n.depth=n.geometry.boundingBox.max.z-n.geometry.boundingBox.min.z,n}function E(e,t){return new THREE.TextGeometry(e,{size:S.textHeight,height:S.depth,curveSegments:4,font:t,weight:"bold",style:"normal",bevelEnabled:!0,bevelThickness:2,bevelSize:1})}function p(e,t,n){if(void 0===e)return new THREE.Mesh(E(t,n),C);e.geometry.computeBoundingBox();var o=e.geometry.clone(),i=E(t,n);o.computeBoundingBox(),i.computeBoundingBox();var r=o.boundingBox.max.x-o.boundingBox.min.x,a=i.boundingBox.max.x-o.boundingBox.min.x,l=i.boundingBox.max.y-o.boundingBox.min.y,s=!1,d=new THREE.Vector3(r,0,0);do{for(var g=d.clone().add(new THREE.Vector3(a/2,l/2,0)),c=0;c<i.vertices.length;c++)if(!(i.vertices[c].z!=g.z||i.vertices[c].x>=a/2)){var m=i.vertices[c].clone(),h=m.sub(new THREE.Vector3(a/2,l/2,0)),p=new THREE.Raycaster(g,h.clone().normalize()),u=p.intersectObject(e);if(u.length>0&&u[0].distance<h.length()){s=!0,o.merge(i,(new THREE.Matrix4).setPosition(d));break}}d.x-=3}while(!s);return new THREE.Mesh(o,C)}function u(e,t,n){var o=(new THREE.Matrix4).setPosition(new THREE.Vector3(-n.width/2,0,0));n.geometry.applyMatrix(o);for(var i=t+n.depth/2,r=2*i*Math.PI,a=0;a<n.geometry.vertices.length;a++){var l=n.geometry.vertices[a],s=t-l.z,d=l.x,g=d/r*Math.PI*2;n.geometry.vertices[a].set(s*Math.sin(g),l.y,s*Math.cos(g)).add(e)}return n.geometry.verticesNeedUpdate=!0,n.geometry.mergeVertices(),n.geometry.computeFaceNormals(),n.geometry.computeVertexNormals(),n}function w(e){var t;if(e=e.toLowerCase(),window.URL=window.URL||window.webkitURL,window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder,"obj"==e){var n=new THREE.OBJExporter;t=n.parse(f)}else if("stl"==e){var n=new THREE.STLExporter;t=n.parse(f)}var o=document.createElement("a");o.style.display="none",document.body.appendChild(o),o.href=URL.createObjectURL(new Blob([t],{type:"text/plain"})),o.download="model."+e,o.click()}function x(){b.aspect=window.innerWidth/window.innerHeight,b.updateProjectionMatrix(),B.setSize(window.innerWidth,window.innerHeight)}function y(){requestAnimationFrame(y),R()}function R(){T.update(),v.update(),B.render(f,b)}(new Date).getTime();Detector.webgl||Detector.addGetWebGLMessage();var H,T,b,v,f,B,M,L,C,z=new THREE.Object3D,S={text:"hello",depth:70,height:0,type:"text",textHeight:158,shapeUrl:"",modelUrl:"",fontUrl:"",materialName:"gold_yellow",fontName:"",positionCalibrated:new THREE.Vector3(0,0,0),rotationCalibrated:new THREE.Euler(0,0,0),cutFlag:!0},F={font:null,shapeGeometry:null,ringGeometry:null,textMesh:null},V=[],U=["img/px.jpg","img/nx.jpg","img/py.jpg","img/ny.jpg","img/pz.jpg","img/nz.jpg"],P=THREE.ImageUtils.loadTextureCube(U);return P.format=THREE.RGBFormat,V.push(i({color:16764482,specular:3355443,combine:THREE.MixOperation,envMap:P,shininess:54,reflectivity:.75,side:THREE.DoubleSide,shading:THREE.SmoothShading},"gold_yellow")),V.push(i({color:16750995,specular:3355443,combine:THREE.MixOperation,envMap:P,shininess:54,reflectivity:.75,side:THREE.DoubleSide,shading:THREE.SmoothShading},"gold_red")),V.push(i({color:16777215,specular:16777215,combine:THREE.MixOperation,envMap:P,shininess:54,reflectivity:.75,side:THREE.DoubleSide,shading:THREE.SmoothShading},"silver")),s(),y(),{init:function(t,n,o,i){return t.length>13?void alert("文字太长"):void e(t,n,o,i)},change:function(e,t){n(e,t)},get:function(e){return o(e)},"export":function(e){w(e)}}};