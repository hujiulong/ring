var Ring=new function(){function e(e,t,o,i){n(e,t,o,i),l(d)}function t(e,t){switch(e){case"models":return j.model+t+".js";case"font":return j.font+t+".json";case"shape":return j.shape+t.substring(1,t.length-1)+".js"}return null}function n(e,n,o,i){P=a(n),G.materialName=n,G.fontName=i,G.text=e,G.modelUrl=t("models",o),p(e)?(G.type="shape",G.shapeUrl=t("shape",e),G.fontUrl=t("font",i)):(G.type="text",G.fontUrl=t("font",i)),"9-1"==o?"text"==G.type&&(G.rotationCalibrated.set(0,0,0),G.positionCalibrated.set(0,0,0),G.cutFlag=!0):"9-2"==o?("text"==G.type?(G.rotationCalibrated.set(0,0,0),G.positionCalibrated.set(0,0,0),G.cutFlag=!0):"shape"==G.type&&(G.rotationCalibrated.set(0,0,0),G.positionCalibrated.set(0,0,-20)),G.cutFlag=!0):"9-3"==o?"text"==G.type&&(G.textHeight=150,G.rotationCalibrated.set(0,0,6/180*Math.PI),G.positionCalibrated.set(0,37,0),G.cutFlag=!1):"9-4"==o?"text"==G.type&&(G.rotationCalibrated.set(0,0,0),G.positionCalibrated.set(-5,0,-20),G.cutFlag=!0):"9-5"==o?"text"==G.type&&(G.rotationCalibrated.set(0,0,0),G.positionCalibrated.set(0,0,0),G.cutFlag=!0,G.depth=50):(G.rotationCalibrated.set(0,0,0),G.positionCalibrated.set(0,0,0),G.cutFlag=!0)}function o(e,o){if("text"==e)N.remove(F),N.remove(U),z.remove(N),N=new THREE.Object3D,G.text=o,p(G.text)?(G.type="shape",G.shapeUrl=t("shape",G.text),null==D.shapeGeometry&&s(G.shapeUrl,d)):(G.type="text",d());else if("height"==e)console.log(o/G.height),N.scale.y=o/G.height;else if("material"==e)for(var i=a(o),r=0;r<N.children.length;r++)N.children[r].material=i;else if("model"==e){n(G.text,G.materialName,o,G.fontName),N.remove(F),N.remove(U),z.remove(N),N=new THREE.Object3D,G.modelUrl="models/"+o+".js";var l=new THREE.JSONLoader;l.load(G.modelUrl,function(e,t){D.ringGeometry=e.clone(),d(e)})}}function i(e){switch(e){case"text":return G.text;case"height":return G.height}}function r(e,t){var n=new THREE.MeshPhongMaterial(e);return n.name=t,n}function a(e){for(var t=0;t<A.length;t++)if(A[t].name==e)return A[t];return A[0]}function l(e){function t(){o.load(G.fontUrl,function(t){n=t,D.font=n,i.load(G.modelUrl,function(t,n){D.ringGeometry=t.clone(),e()})})}var n,o=new THREE.FontLoader,i=new THREE.JSONLoader;"shape"==G.type?i.load(G.shapeUrl,function(e,n){D.shapeGeometry=e,t()}):"text"==G.type&&t()}function s(e,t){var e,n=new THREE.JSONLoader;"shape"==G.type?e=G.shapeUrl:"text"==G.type&&(e=G.modelUrl),n.load(e,function(e,n){"shape"==G.type?D.shapeGeometry=e:"text"==G.type&&(D.ringGeometry=e),t()})}function d(){console.log("load "+((new Date).getTime()-B)+"ms"),"shape"==G.type?U=w():"text"==G.type&&(U=x(G.text,D.font)),F=g()}function c(){V=new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,1,1e4),V.position.set(0,0,2e3),M=document.getElementById("container"),C=new THREE.TrackballControls(V,M),C.rotateSpeed=1,C.zoomSpeed=1.2,C.panSpeed=.8,C.noZoom=!1,C.noPan=!1,C.staticMoving=!0,C.dynamicDampingFactor=.3,z=new THREE.Scene,e=new THREE.DirectionalLight(16777190,.95),e.position.set(0,100,200),z.add(e),e=new THREE.DirectionalLight(16777190,.75),e.position.set(0,-100,-200),z.add(e);var e=new THREE.HemisphereLight(13365758,16773846,.4);z.add(e);var e=new THREE.AmbientLight(4210752);z.add(e),S=new THREE.WebGLRenderer({antialias:!0}),S.setPixelRatio(window.devicePixelRatio),S.setClearColor(16777215),S.setSize(window.innerWidth,window.innerHeight),M.appendChild(S.domElement),L=new Stats,L.domElement.style.position="absolute",L.domElement.style.top="0px",L.domElement.style.zIndex=100,M.appendChild(L.domElement),window.addEventListener("resize",b,!1)}function g(){function e(e,t,n){return!!(G.cutFlag&&e.distanceToPoint(n)>0&&t.distanceToPoint(n)>0)}var t,n=D.ringGeometry.clone(),o=new THREE.Vector3,i=[],r=[],a=[],l=[],s=(new THREE.Matrix4).makeRotationX(-Math.PI/2).multiply((new THREE.Matrix4).makeScale(50,50,50));n.applyMatrix(s),n.verticesNeedUpdate=!0,n.computeBoundingBox(),t=(n.boundingBox.max.x-n.boundingBox.min.x)/2,o.set(t+n.boundingBox.min.x,0,t+n.boundingBox.min.z),G.height=n.boundingBox.max.y-n.boundingBox.min.y;var d=(U.width/2-7)/(t+U.depth/2),c=(new THREE.Vector3).crossVectors(new THREE.Vector3(0,0,1).applyAxisAngle(new THREE.Vector3(0,1,0),d).normalize(),new THREE.Vector3(0,1,1).applyAxisAngle(new THREE.Vector3(0,1,0),d).normalize()),g=(new THREE.Vector3).crossVectors(new THREE.Vector3(0,0,1).applyAxisAngle(new THREE.Vector3(0,1,0),-d).normalize(),new THREE.Vector3(0,1,1).applyAxisAngle(new THREE.Vector3(0,1,0),-d).normalize()),m=new THREE.Plane;m.setFromNormalAndCoplanarPoint(c.normalize(),o);var p=new THREE.Plane;p.setFromNormalAndCoplanarPoint(g.normalize().negate(),o);for(var E=0;E<n.faces.length;E++){var w=n.faces[E],x=n.vertices[w.a],y=n.vertices[w.b],f=n.vertices[w.c],T=[x,y,f],b=[0,0,0],v=[],H=[];e(m,p,x)&&(b[0]=1),e(m,p,y)&&(b[1]=1),e(m,p,f)&&(b[2]=1);for(var M=0;M<b.length;M++)b[M]?H.push(T[M]):v.push(T[M]);if(0==H.length)i.push(x,y,f),r.push(new THREE.Face3(i.length-1,i.length-2,i.length-3));else if(1==H.length){var L,V,C=new THREE.Line3(H[0],v[0]),S=new THREE.Line3(H[0],v[1]),j=1,A=1;void 0!=(L=m.intersectLine(C))?j=1:(L=p.intersectLine(C),j=2),void 0!=(V=m.intersectLine(S))?A=1:(V=p.intersectLine(S),A=2),i.push(v[0],v[1],L,V);var O=u(i[i.length-1].clone(),o,t-20).sub(L.clone());r.push(h(i,i.length-1,i.length-2,i.length-3,O)),r.push(h(i,i.length-2,i.length-3,i.length-4,O)),1==j?a.push(i.length-2):l.push(i.length-2),1==A?a.push(i.length-1):l.push(i.length-1)}else if(2==H.length){var L,V,C=new THREE.Line3(v[0],H[0]),S=new THREE.Line3(v[0],H[1]),j=1,A=1;void 0!=(L=m.intersectLine(C))?j=1:(L=p.intersectLine(C),j=2),void 0!=(V=m.intersectLine(S))?A=1:(V=p.intersectLine(S),A=2),i.push(v[0],L,V);var O=u(i[i.length-1].clone(),o,t-20).sub(L.clone());r.push(h(i,i.length-1,i.length-2,i.length-3,O)),1==j?a.push(i.length-2):l.push(i.length-2),1==A?a.push(i.length-1):l.push(i.length-1)}}var k=new THREE.Geometry;k.vertices=i,k.faces=r;var I=[],W=[],J=new THREE.Geometry;G.cutFlag&&a.length>0&&l.length>0&&I.push(i[a[0]],i[l[0]]);for(var O=new THREE.Vector3(0,0,(-1)),E=2;E<a.length;E++)I.push(i[a[E-1]],i[a[E]]),W.push(h(I,0,I.length-1,I.length-2,O));for(var E=2;E<l.length;E++)I.push(i[l[E-1]],i[l[E]]),W.push(h(I,1,I.length-1,I.length-2,O));J.vertices=I,J.faces=W,J.mergeVertices(),J.computeFaceNormals(),J.computeVertexNormals(),k.mergeVertices(),k.computeFaceNormals(),k.computeVertexNormals(),k.merge(J),F=new THREE.Mesh(k,P),z.add(F),N.add(F),U=R(o,t,U),U.position.copy(G.positionCalibrated),U.position.y-=G.textHeight/2,U.rotation.copy(G.rotationCalibrated),N.add(U),edges=new THREE.EdgesHelper(U,65280),z.add(N),console.log("total "+((new Date).getTime()-B)+"ms")}function h(e,t,n,o,i){var r=m(e[t].clone(),e[n].clone(),e[o].clone());return i.angleTo(r)<=Math.PI/2?new THREE.Face3(t,n,o):new THREE.Face3(o,n,t)}function m(e,t,n){var o=new THREE.Vector3,i=new THREE.Vector3;return o.subVectors(n,t),i.subVectors(e,t),o.cross(i),o.normalize()}function u(e,t,n){var o=e.sub(t.clone().setY(e.y));return o.setLength(n)}function p(e){var t=/\[\S+\]/g;return t.test(e)}function E(e){return e>="A"&&e<="Z"||"p"==e||"s"==e||"1"==e}function w(){var e=D.shapeGeometry.clone(),t=new THREE.Mesh(e,P);return t.geometry.applyMatrix((new THREE.Matrix4).makeScale(50,50,50)),t.geometry.computeBoundingBox(),t.width=t.geometry.boundingBox.max.x-t.geometry.boundingBox.min.x,t.height=t.geometry.boundingBox.max.y-t.geometry.boundingBox.min.y,t.depth=t.geometry.boundingBox.max.z-t.geometry.boundingBox.min.z,t.geometry.applyMatrix((new THREE.Matrix4).setPosition(new THREE.Vector3(t.width/2,t.height/2,t.depth/2))),t}function x(e,t){for(var n,e=G.text,o=0,i=0,r=0;r<e.length;r++)E(e[r])||r==e.length-1?(i&&(i=0,n=f(n,e.substring(o,r))),n=f(n,e[r])):i||(i=1,o=r);return n.geometry.computeBoundingBox(),n.width=n.geometry.boundingBox.max.x-n.geometry.boundingBox.min.x,n.height=n.geometry.boundingBox.max.y-n.geometry.boundingBox.min.y,n.depth=n.geometry.boundingBox.max.z-n.geometry.boundingBox.min.z,n}function y(e){return new THREE.TextGeometry(e,{size:G.textHeight,height:G.depth,curveSegments:4,font:D.font,weight:"bold",style:"normal",bevelEnabled:!0,bevelThickness:2,bevelSize:1})}function f(e,t,n){if(void 0===e)return new THREE.Mesh(y(t,n),P);e.geometry.computeBoundingBox();var o=e.geometry.clone(),i=y(t,n);o.computeBoundingBox(),i.computeBoundingBox();var r=o.boundingBox.max.x-o.boundingBox.min.x,a=i.boundingBox.max.x-o.boundingBox.min.x,l=i.boundingBox.max.y-o.boundingBox.min.y,s=!1,d=new THREE.Vector3(r,0,0);do{for(var c=d.clone().add(new THREE.Vector3(a/2,l/2,0)),g=0;g<i.vertices.length;g++)if(!(i.vertices[g].z!=c.z||i.vertices[g].x>=a/2)){var h=i.vertices[g].clone(),m=h.sub(new THREE.Vector3(a/2,l/2,0)),u=new THREE.Raycaster(c,m.clone().normalize()),p=u.intersectObject(e);if(p.length>0&&p[0].distance<m.length()){s=!0,o.merge(i,(new THREE.Matrix4).setPosition(d));break}}d.x-=3}while(!s);return new THREE.Mesh(o,P)}function R(e,t,n){var o=(new THREE.Matrix4).setPosition(new THREE.Vector3(-n.width/2,0,0));n.geometry.applyMatrix(o);for(var i=t+n.depth/2,r=2*i*Math.PI,a=0;a<n.geometry.vertices.length;a++){var l=n.geometry.vertices[a],s=t-l.z,d=l.x,c=d/r*Math.PI*2;n.geometry.vertices[a].set(s*Math.sin(c),l.y,s*Math.cos(c)).add(e)}return n.geometry.verticesNeedUpdate=!0,n.geometry.mergeVertices(),n.geometry.computeFaceNormals(),n.geometry.computeVertexNormals(),n}function T(e){var t;if(e=e.toLowerCase(),window.URL=window.URL||window.webkitURL,window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder,"obj"==e){var n=new THREE.OBJExporter;t=n.parse(z)}else if("stl"==e){var n=new THREE.STLExporter;t=n.parse(z)}var o=document.createElement("a");o.style.display="none",document.body.appendChild(o),o.href=URL.createObjectURL(new Blob([t],{type:"text/plain"})),o.download="model."+e,o.click()}function b(){V.aspect=window.innerWidth/window.innerHeight,V.updateProjectionMatrix(),S.setSize(window.innerWidth,window.innerHeight)}function v(){requestAnimationFrame(v),H()}function H(){L.update(),C.update(),S.render(z,V)}var B=(new Date).getTime();Detector.webgl||Detector.addGetWebGLMessage();var M,L,V,C,z,S,U,F,P,N=new THREE.Object3D,j={font:"fonts/",model:"models/",shape:"models/"},G={text:"hello",depth:70,height:0,type:"text",textHeight:158,shapeUrl:"",modelUrl:"",fontUrl:"",materialName:"gold_yellow",fontName:"",positionCalibrated:new THREE.Vector3(0,0,0),rotationCalibrated:new THREE.Euler(0,0,0),cutFlag:!0},D={font:null,shapeGeometry:null,ringGeometry:null},A=[],O=["img/px.jpg","img/nx.jpg","img/py.jpg","img/ny.jpg","img/pz.jpg","img/nz.jpg"],k=THREE.ImageUtils.loadTextureCube(O);return k.format=THREE.RGBFormat,A.push(r({color:16764482,specular:3355443,combine:THREE.MixOperation,envMap:k,shininess:54,reflectivity:.75,side:THREE.DoubleSide,shading:THREE.SmoothShading},"gold_yellow")),A.push(r({color:16750995,specular:3355443,combine:THREE.MixOperation,envMap:k,shininess:54,reflectivity:.75,side:THREE.DoubleSide,shading:THREE.SmoothShading},"gold_red")),A.push(r({color:16777215,specular:16777215,combine:THREE.MixOperation,envMap:k,shininess:54,reflectivity:.75,side:THREE.DoubleSide,shading:THREE.SmoothShading},"silver")),c(),v(),{init:function(t,n,o,i){return t.length>13?void alert("文字太长"):void e(t,n,o,i)},change:function(e,t){o(e,t)},get:function(e){return i(e)},"export":function(e){T(e)}}};